---
output: html_document
editor_options: 
  chunk_output_type: console
format:
  html:
    html-table-processing: none
---

# Inventories {.unnumbered}

```{r packages and functions}
#| include: false
library(tidyverse)
library(gt)
library(yaml)
source("script/utils.R")
options(readr.show_col_types = FALSE)

params <- read_yaml("data/config.yml")

print_inventory <- function(ref, pattern, cols, return_tibble = FALSE) {
  tbl_inventory <- 
    read_rds("data_generated/works.rds") %>%
      left_join(
        read_csv("data/catalogue_overview.csv") %>% distinct(group, file),
        by = "group"
      ) %>%
      unite(group:number, col = "id", sep = ".", na.rm = TRUE) %>%
      mutate(id = str_glue("[{id}](/groups/{file}.html#work-{id})")) %>%
      separate_longer_delim(inventories, ", @") %>%
      filter(str_detect(inventories, ref)) %>%
      rowwise() %>%
      mutate(
        entries =
          str_match_all(inventories, pattern)[[1]] %>%
          magrittr::set_colnames(c("match", cols)) %>%
          as_tibble() %>%
          select(!match) %>%
          list()
      ) %>%
      unnest(entries) %>%
      select(all_of(cols), id) %>% 
      mutate(across(!id, parse_guess)) %>%
      arrange(pick(!id))
  
  if (return_tibble)
    return(tbl_inventory)
  
  tbl_inventory %>% 
    summarise(.by = all_of(cols), id = str_flatten_comma(id)) %>% 
    arrange(across(all_of(cols), \(c) str_rank(c, numeric = TRUE))) %>% 
    gt() %>%
    fmt_markdown(columns = id) %>%
    cols_label(id = params$catalogue_prefix) %>% 
    tab_options(
      column_labels.font.weight = "bold",
      table.align = "left",
      table_body.hlines.style = "none"
    )
}
```



## Historic

### @BrtniceInv

```{r Brtnice}
#| echo: false
#| output: asis
print_inventory(
  "BrtniceInv",
  pattern = "p. (\\w+), no. (\\w+)",
  cols = c("p.", "no.")
)
```


### @EsterhazyInv1812

```{r Esterhazy 1812}
#| echo: false
#| output: asis
print_inventory(
  "EsterhazyInv1812",
  pattern = "([\\w\\s]+) no. ([\\w-]+)",
  cols = c("genre", "no.")
)
```


### Herzogenburg

```{r A-H setup}
#| echo: false
inv_a <-
  print_inventory(
    "HerzogenburgInvA",
    pattern = "p. (\\w+), no. (\\w+)",
    cols = c("p.", "no."),
    return_tibble = TRUE
  ) %>%
  summarise(
    .by = c(p., no.),
    id = str_flatten_comma(id)
  )

inv_b <-
  print_inventory(
    "HerzogenburgInvB",
    pattern = "fol. (\\w+), no. (\\w+)",
    cols = c("fol.", "no."),
    return_tibble = TRUE
  ) %>%
  summarise(
    .by = c(fol., no.),
    id = str_flatten_comma(id)
  )

works_herzogenburg <- read_csv("data/inventory_herzogenburg_works.csv")

# all citations of inventory A in work table are in inventory table
stopifnot(
  anti_join(
    inv_a,
    works_herzogenburg,
    by = join_by(p. == page_1751, no. == number_1751)
  ) %>%
    nrow == 0L
)

# all citations of inventory B in work table are in inventory table
stopifnot(
  anti_join(
    inv_b,
    works_herzogenburg,
    by = join_by(fol. == folio_1774, no. == number_1774)
  ) %>%
    nrow == 0L
)

table_data <-
  works_herzogenburg %>%
  left_join(
    inv_a,
    by = join_by(page_1751 == p., number_1751 == no.)
  ) %>%
  left_join(
    inv_b,
    by = join_by(folio_1774 == fol., number_1774 == no.),
    suffix = c("_1751", "_1774")
  ) %>%
  rowwise() %>%
  mutate(
    is_error = any(
      is.na(shelfmark) &
        !is.na(section_1751) &
        is.na(id_1751),
      is.na(shelfmark) &
        !is.na(section_1774) &
        is.na(id_1774),
      is.na(shelfmark) &
        !is.na(section_1751) &
        !is.na(section_1774) &
        id_1751 != id_1774
    )
  ) %>%
  mutate(TumW = coalesce(id_1751, id_1774))

if (any(table_data$is_error)) {
  print(table_data %>% filter(is_error))
  error("Problems found in A-H inventory")
}

n_works_1751 <- 
  table_data %>%
  filter(!is.na(section_1751)) %>%
  distinct(section_1751, page_1751, number_1751) %>%
  nrow()

n_works_1774 <- 
  table_data %>%
  filter(!is.na(section_1751)) %>%
  distinct(section_1751, page_1751, number_1751) %>%
  nrow()

n_works_extant <- 
  table_data %>%
  filter(!is.na(shelfmark)) %>%
  distinct(shelfmark) %>%
  nrow()
```

The two historic inventories of Stift Herzogenburg [@HerzogenburgInvA; @HerzogenburgInvB] contain `{r} n_works_1751` and `{r} n_works_1774` entries describing Tůma's works, respectively. However, only `{r} n_works_extant` shelfmarks are extant.

```{r A-H inventories}
#| echo: false
#| output: asis

table_data %>% 
  select(!id_1751:is_error) %>%
  relocate(TumW, .after = shelfmark) %>% 
  gt() %>%
  tab_spanner("inventory 1751 (A)", columns = ends_with("1751")) %>%
  tab_spanner("inventory 1774 (B)", columns = ends_with("1774")) %>%
  cols_label(
    starts_with("section") ~ "section",
    starts_with("page") ~ "p.",
    starts_with("folio") ~ "fol.",
    starts_with("number") ~ "no."
  ) %>%
  cols_align("right", section_1751:shelfmark) %>%
  fmt_markdown(columns = TumW) %>%
  sub_missing(missing_text = "") %>%
  tab_options(
    column_labels.font.weight = "bold",
    table_body.hlines.style = "none"
  )
```

In the table above, sections in the 1751 inventory have been consecutively numbered as follows:

```{r A-H inventory 1751 sections}
#| echo: false
#| output: asis

read_csv("data/inventory_herzogenburg_1751.csv") %>% 
  unite(from, to, col = "pp.", sep = "–") %>% 
  gt() %>%
  cols_align("right", columns = "pp.") %>%
  sub_missing(missing_text = "") %>%
  tab_options(
    column_labels.font.weight = "bold",
    table_body.hlines.style = "none"
  )
```

Likewise, sections in the 1774 inventory have been consecutively numbered as follows:

```{r A-H inventory 1774 sections}
#| echo: false
#| output: asis

read_csv("data/inventory_herzogenburg_1774.csv") %>% 
  unite(from, to, col = "fol.", sep = "–") %>% 
  gt() %>%
  cols_width("fol." ~ px(90)) %>%
  cols_align("right", columns = "fol.") %>%
  sub_missing(missing_text = "") %>%
  tab_options(
    column_labels.font.weight = "bold",
    table_body.hlines.style = "none"
  )
```


### Klosterneuburg

```{r A-KN setup}
#| echo: false
inv_a <-
  print_inventory(
    "KlosterneuburgInvA",
    pattern = "p. (\\w+), no. (\\w+)",
    cols = c("p.", "no."),
    return_tibble = TRUE
  ) %>%
  summarise(
    .by = c(p., no.),
    id = str_flatten_comma(id)
  )

inv_b <-
  print_inventory(
    "KlosterneuburgInvB",
    pattern = "p. (\\w+), no. (\\w+)",
    cols = c("p.", "no."),
    return_tibble = TRUE
  ) %>%
  summarise(
    .by = c(p., no.),
    id = str_flatten_comma(id)
  )

inv_c <-
  print_inventory(
    "KlosterneuburgInvC",
    pattern = "vol. (\\w+), p. (\\w+), no. (\\w+)",
    cols = c("vol.", "p.", "no."),
    return_tibble = TRUE
  ) %>%
  summarise(
    .by = c(vol., p., no.),
    id = str_flatten_comma(id)
  )

inv_e <-
  print_inventory(
    "KlosterneuburgInvE",
    pattern = "p. (\\w+), no. (\\w+)",
    cols = c("p.", "no."),
    return_tibble = TRUE
  ) %>%
  summarise(
    .by = c(p., no.),
    id = str_flatten_comma(id)
  )

shelfmarks <- 
  read_rds("data_generated/works.rds") %>%
  unnest(sources, names_sep = "_") %>%
  filter(str_starts(sources_source, "A-KN ")) %>%
  left_join(
    read_csv("data/catalogue_overview.csv") %>% distinct(group, file),
    by = "group"
  ) %>%
  unite(group:number, col = "id", sep = ".", na.rm = TRUE) %>%
  mutate(id = str_glue("[{id}](/groups/{file}.html#work-{id})")) %>% 
  select(shelfmark = sources_source, id) %>%
  mutate(shelfmark = str_replace(shelfmark, "A-KN ", ""))

works_klosterneuburg <- read_csv("data/inventory_klosterneuburg.csv")

# all citations of inventory A in work table are in inventory table
stopifnot(
  anti_join(
    inv_a,
    works_klosterneuburg,
    by = join_by(p. == page_a, no. == number_a)
  ) %>%
    nrow == 0L
)

# all citations of inventory B in work table are in inventory table
stopifnot(
  anti_join(
    inv_b,
    works_klosterneuburg,
    by = join_by(p. == page_b, no. == number_b)
  ) %>%
    nrow == 0L
)

# all citations of inventory C in work table are in inventory table
stopifnot(
  anti_join(
    inv_c,
    works_klosterneuburg,
    by = join_by(vol. == volume_c, p. == page_c, no. == number_c)
  ) %>%
    nrow == 0L
)

# all citations of inventory E in work table are in inventory table
stopifnot(
  anti_join(
    inv_e,
    works_klosterneuburg,
    by = join_by(p. == page_e, no. == number_e)
  ) %>%
    nrow == 0L
)

# all extant shelfmarks are in inventory table
stopifnot(
  anti_join(
    shelfmarks,
    works_klosterneuburg,
    by = "shelfmark"
  ) %>%
    nrow == 0L
)

table_data <-
  works_klosterneuburg %>%
  left_join(
    inv_a %>% rename(id_a = id),
    by = join_by(page_a == p., number_a == no.)
  ) %>%
  left_join(
    inv_b %>% rename(id_b = id),
    by = join_by(page_b == p., number_b == no.)
  ) %>%
  left_join(
    inv_c %>% rename(id_c = id),
    by = join_by(volume_c == vol., page_c == p., number_c == no.)
  ) %>%
  left_join(
    inv_e %>% rename(id_e = id),
    by = join_by(page_e == p., number_e == no.)
  ) %>%
  left_join(
    shelfmarks %>% rename(id_s = id),
    by = "shelfmark"
  ) %>%
  rowwise() %>%
  mutate(
    is_error = any(
      !is.na(shelfmark) &
        is.na(id_s),
      is.na(shelfmark) &
        !is.na(page_a) &
        is.na(id_a),
      is.na(shelfmark) &
        !is.na(page_b) &
        is.na(id_b),
      is.na(shelfmark) &
        !is.na(page_c) &
        is.na(id_c),
      is.na(shelfmark) &
        !is.na(page_e) &
        is.na(id_e)
    )
  ) %>%
  mutate(TumW = coalesce(id_a, id_b, id_c, id_e, id_s))

if (any(table_data$is_error)) {
  print(table_data %>% filter(is_error))
  error("Problems found in A-H inventory")
}

n_works_a <- 
  table_data %>%
  filter(!is.na(page_a)) %>%
  distinct(page_a, number_a) %>%
  nrow()

n_works_b <- 
  table_data %>%
  filter(!is.na(page_b)) %>%
  distinct(page_b, number_b) %>%
  nrow()

n_works_c <- 
  table_data %>%
  filter(!is.na(page_c)) %>%
  distinct(volume_c, page_c, number_c) %>%
  nrow()

n_works_e <- 
  table_data %>%
  filter(!is.na(page_e)) %>%
  distinct(page_e, number_e) %>%
  nrow()

n_works_extant <- 
  table_data %>%
  filter(!is.na(shelfmark)) %>%
  distinct(shelfmark) %>%
  nrow()
```

The historic inventories of Stift Klosterneuburg [@KlosterneuburgInvA; @KlosterneuburgInvB; KlosterneuburgInvC; KlosterneuburgInvE] contain `{r} n_works_a`, `{r} n_works_b`, `{r} n_works_c`, and `{r} n_works_e` entries describing Tůma's works, respectively. However, only `{r} n_works_extant` shelfmarks are extant.

```{r A-KN table}
#| echo: false
#| output: asis

table_data %>% 
  select(!id_a:is_error) %>%
  gt() %>%
  tab_spanner("inventory A", columns = ends_with("_a")) %>% 
  tab_spanner("inventory B", columns = ends_with("_b")) %>% 
  tab_spanner("inventory C", columns = ends_with("_c")) %>% 
  tab_spanner("inventory E", columns = ends_with("_e")) %>% 
  cols_label(
    starts_with("volume") ~ "vol.",
    starts_with("page") ~ "p.",
    starts_with("number") ~ "no."
  ) %>%
  cols_align("right", !TumW) %>% 
  fmt_markdown(columns = TumW) %>% 
  sub_missing(missing_text = "") %>%
  tab_options(
    column_labels.font.weight = "bold",
    table_body.hlines.style = "none"
  )
```


### @MelkInv

```{r Melk}
#| echo: false
#| output: asis
print_inventory(
  "MelkInv",
  pattern = "vol. (\\w+), no. (\\w+)",
  cols = c("vol.", "no.")
)
```


### @OsekInv

```{r Osek}
#| echo: false
#| output: asis
print_inventory(
  "OsekInv",
  pattern = "fol. (\\w+), no. (\\w+)",
  cols = c("fol.", "no.")
)
```


### @RajhradInvA

```{r Rajhrad A}
#| echo: false
#| output: asis
print_inventory(
  "RajhradInvA",
  pattern = "p. (\\w+), no. (\\w+)",
  cols = c("p", "no.")
)
```


### @RajhradInvB

```{r Rajhrad B}
#| echo: false
#| output: asis
print_inventory(
  "RajhradInvB",
  pattern = "p. (\\w+), no. (\\w+)",
  cols = c("p", "no.")
)
```



## Modern

### @Bardos1980

```{r Bardos 1980}
#| echo: false
#| output: asis
print_inventory(
  "Bardos1980",
  pattern = "p. (\\w+), no. ([\\w/]+)",
  cols = c("p.", "no.")
)
```


### @Pulkert1973

```{r Pulkert 1973}
#| echo: false
#| output: asis
print_inventory(
  "Pulkert1973",
  pattern = "p. (\\w+), no. ([\\w/]+)",
  cols = c("p.", "no.")
)
```


### @Riedel1979

```{r Riedel 1979}
#| echo: false
#| output: asis
print_inventory(
  "Riedel1979",
  pattern = "p. (\\w+), no. (\\w+)",
  cols = c("p.", "no.")
)
```


### @Sherman2001

```{r Sherman 2001}
#| echo: false
#| output: asis
print_inventory(
  "Sherman2001",
  pattern = "p. (\\w+), no. (\\w+)",
  cols = c("p.", "no.")
)
```


### @Stefan1985

```{r Stefan 1985}
#| echo: false
#| output: asis
print_inventory(
  "Stefan1985",
  pattern = "p. (\\w+), no. (\\w+)",
  cols = c("p.", "no.")
)
```
